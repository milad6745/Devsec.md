حتماً! بیاییم همه چیز را از اول مرتب کنیم و با توضیحات کامل بنویسیم تا یک نگاه جامع روی **Seccomp و پروفایل‌های Docker** داشته باشیم، و در نهایت پروفایلی داشته باشیم که همه چیز فعال باشه ولی `mount` بلاک بشه.

---

# ۱️⃣ Seccomp چیست؟

**Seccomp (Secure Computing Mode)** یک مکانیزم امنیتی در لینوکس است که به پروسه‌ها اجازه می‌دهد **مجموعه‌ای از system callها را محدود یا اجازه دهند**.

* در Docker، از Seccomp برای **محدود کردن دسترسی کانتینر به syscallهای حساس** استفاده می‌شود.
* به این شکل می‌توان کانتینر را امن‌تر کرد و جلوی اجرای syscallهای خطرناک روی میزبان را گرفت.

### 🔹 مثال کاربرد:

* جلوگیری از اجرای `mount` داخل کانتینر
* جلوگیری از تغییر namespaceها
* اجازه دادن فقط به syscallهای ضروری برای اجرای برنامه داخل کانتینر

---

# ۲️⃣ ساختار پروفایل Seccomp در Docker

یک پروفایل Seccomp معمولاً JSON است و شامل این بخش‌هاست:

1. **defaultAction**

   * مشخص می‌کند syscallهایی که در لیست نیستند چه اتفاقی بیافتد.
   * نمونه‌ها:

     * `SCMP_ACT_ALLOW` → اجازه اجرا
     * `SCMP_ACT_ERRNO` → خطا برگردانده شود
     * `SCMP_ACT_KILL` → کانتینر متوقف شود

2. **syscalls**

   * یک آرایه از قوانین برای syscallهای خاص
   * هر قانون شامل:

     * `names` → لیست syscallهای مورد نظر
     * `action` → چه عملی روی آن syscall انجام شود

---

# ۳️⃣ نمونه پروفایل محدودکننده (مینیمال)

مثلاً می‌خواهیم فقط syscallهای لازم برای اجرای یک Alpine ساده را اجازه بدهیم:

```json
{
  "defaultAction": "SCMP_ACT_ERRNO",
  "syscalls": [
    {
      "names": ["read","write","exit","sigreturn","open","close","execve"],
      "action": "SCMP_ACT_ALLOW"
    }
  ]
}
```

✅ این پروفایل باعث می‌شود که تنها syscallهای لیست شده اجازه داشته باشند و بقیه خطا بدهند.

❌ مشکل: اگر syscallهای مورد نیاز مثل `getdents64` یا `fstatfs` حذف شوند، کانتینر اصلاً بالا نمی‌آید.

---

# ۴️⃣ نسخه نهایی پیشنهادی شما: همه چیز فعال ولی mount بلاک شود

طبق درخواست شما، می‌خواهیم:

* **همه syscallها فعال باشند** (تا کانتینر همه کارها را انجام دهد)
* ولی syscallهای مربوط به **mount و umount** خطا بدهند

```json
{
  "defaultAction": "SCMP_ACT_ALLOW",
  "syscalls": [
    {
      "names": ["mount", "umount", "umount2"],
      "action": "SCMP_ACT_ERRNO"
    }
  ]
}
```

### 🔹 توضیح:

* `defaultAction: SCMP_ACT_ALLOW` → همه syscallها اجازه دارند
* `mount, umount, umount2` → اگر اجرا شوند، **خطای EPERM برمی‌گردد**
* کانتینر می‌تواند اجرا شود و اکثر برنامه‌ها بدون مشکل کار کنند
* فقط عملیات mount مسدود می‌شود

### 🔹 نحوه اجرا:

```bash
docker run --rm --security-opt seccomp=profile.json alpine:latest
```

---

اگر بخواهیم می‌توانیم یک **نسخه پیشرفته‌تر** بسازیم که فقط mountهای خاص (مثل bind mounts یا network mounts) را بلاک کند ولی mountهای read-only ساده را آزاد کند.

می‌خوای اون نسخه پیشرفته را هم آماده کنم؟
